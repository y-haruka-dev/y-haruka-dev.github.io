<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ポモドーロタイマー</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#ffffff; --ui-fg:#111827; --muted:#5a6473;
    --card:rgba(255,255,255,.20);
    --line:#e6eaf1;
    --brand:#5cc9ee; --brand2:#9aa7ff;
    --radius:12px;
    --wrap:1000px; --btnh:44px;

    --font:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
    --font-timer:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;

    --fg-timer:#000000;
    --icons:var(--ui-fg);

    --timer-box-h:clamp(220px,36vw,360px); /* PC/タブレット */

    --field-bg:#ffffff; --field-fg:#111827;
    --field-border:#e5e7eb; --field-focus:#7dd3fc;

    /* モバイルのボトムナビをやや高めに */
    --bottom-nav-h:80px;
  }

  *{box-sizing:border-box}
  html{font-size:17px}
  body{margin:0;background:var(--bg);color:var(--ui-fg);font-family:var(--font);line-height:1.7}
  .wrap{max-width:var(--wrap);margin:auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  .small-note{font-size:12px;font-weight:400}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* App bar */
  .appbar{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);
    background:var(--card);border:1px solid var(--line);border-radius:16px;padding:10px 12px;margin-bottom:12px;
    display:flex;justify-content:space-between;align-items:center}
  .logo{font-weight:800}
  .tabs{display:flex;gap:6px;align-items:center;flex-wrap:nowrap}
  .tabs a{color:var(--ui-fg) !important;text-decoration:none !important;border:1px solid transparent;
    display:inline-flex;gap:6px;align-items:center;padding:.45rem .7rem;border-radius:10px;white-space:nowrap}
  .tabs a.active{border-color:var(--line);background:color-mix(in oklab,var(--bg) 10%, transparent)}

  /* フォーム/ボタン */
  select,input,button{height:var(--btnh);padding:.6rem .8rem;border:1px solid var(--field-border);border-radius:10px;background:var(--field-bg);color:var(--field-fg)}
  input[type=number]{width:88px}
  input::placeholder{color:color-mix(in oklab,var(--field-fg) 70%,var(--field-bg) 30%)}
  select:focus,input:focus,button:focus{outline:none;border-color:var(--field-focus);box-shadow:0 0 0 3px color-mix(in oklab,var(--field-focus) 35%,transparent)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer}
  .primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#081018;border:none;font-weight:700}
  .danger{border-color:#ff6b6b}

  /* Timer */
  .timer-wrap{display:flex;flex-direction:column;align-items:center;padding:56px 8px 18px}
  .timer-box{position:relative;width:min(92vw,780px);height:var(--timer-box-h);display:flex;align-items:center;justify-content:center;border-radius:18px;overflow:hidden;margin:20px 0 32px}
  .timer-bg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.7;pointer-events:none;filter:saturate(.9) blur(.3px)}
  .timer{position:relative;font-weight:800;font-size:clamp(72px,14vw,140px);letter-spacing:.04em;text-align:center;margin:0;color:var(--fg-timer);font-family:var(--font-timer)}
  .timer.is-break{opacity:.25;filter:grayscale(.35) saturate(.5)}
  .btn-row{display:flex;gap:14px;justify-content:center;margin-top:22px;margin-bottom:28px}
  .icon-btn{width:56px;height:56px;border-radius:14px;color:var(--icons)}
  .primary.icon-btn{color:#081018}
  .icon{width:22px;height:22px}

  /* Table/Grid */
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:15px}
  th,td{border-bottom:1px solid var(--line);padding:.55rem .4rem;text-align:left}
  .right{text-align:right}
  .grid{display:grid;gap:14px}
  @media (min-width:600px){ .grid-2{grid-template-columns:1.2fr 1fr} }

  /* ===== ボトムタブ（モバイルだけ表示） ===== */
  .bottom-tabs{display:none}
  @media (max-width:480px){
    html{font-size:14.5px} /* 文字を少し小さく */
    .wrap{
      padding:12px;
      /* ボトムナビ高さ + セーフエリア + さらに余白（かぶり防止） */
      padding-bottom:calc(12px + var(--bottom-nav-h) + env(safe-area-inset-bottom) + 24px);
    }
    .appbar{padding:8px 10px}
    .tabs{display:none} /* 上のタブを隠す */

    /* 基本設定：縦積み */
    [role="group"][aria-label="基本設定"] > label{flex:1 1 100%;min-width:0}
    #newCat{flex:1 1 100%}
    input[type=number]{width:100%}

    /* タイマー：正方形に（両端トリミングOK） */
    .timer-box{
      width:min(92vw,520px);
      height:auto;
      aspect-ratio:1/1;
      margin:16px 0 24px;
    }
    .timer-bg{background-size:cover;background-position:center}
    .timer{font-size:clamp(48px,17vw,120px)}
    .timer-wrap{padding:36px 8px 12px}

    .icon-btn{width:48px;height:48px;border-radius:12px}
    .icon{width:20px;height:20px}
    .btn-row{gap:10px;margin-top:14px;margin-bottom:18px}
    table{font-size:14px} th,td{padding:.5rem .35rem}

    /* ★下部固定ナビ：常時表示を強制 */
    .bottom-tabs{
      position:fixed;left:0;right:0;bottom:0;
      height:var(--bottom-nav-h);
      padding:10px max(10px,env(safe-area-inset-left))
               calc(10px + env(safe-area-inset-bottom) + 18px)
               max(10px,env(safe-area-inset-right));
      display:flex !important;                 /* ← 何があっても表示 */
      z-index:10000;                           /* ← 前面に */
      justify-content:space-around;align-items:center;
      background:var(--card);border-top:1px solid var(--line);backdrop-filter:blur(8px)
    }
    .bt{width:54px;height:54px;border-radius:12px;border:1px solid transparent;background:transparent;color:var(--icons);
        display:flex;align-items:center;justify-content:center}
    .bt.active{border-color:var(--line);background:color-mix(in oklab,var(--bg) 10%, transparent)}
    .bt svg{width:22px;height:22px}
  }
  @media (max-width:360px){
    html{font-size:14px}
    .timer{font-size:clamp(44px,18vw,112px)}
  }
</style>
</head>
<body>

  <div class="wrap">
    <header class="appbar">
      <strong class="logo">Pomodoro</strong>
      <nav class="tabs" aria-label="タブ">
        <a href="#clock" data-tab="clock" aria-controls="view-clock">時計</a>
        <a href="#timer" class="active" data-tab="timer" aria-controls="view-timer">タイマー</a>
        <a href="#logs"  data-tab="logs"  aria-controls="view-logs">履歴</a>
        <a href="#stats" data-tab="stats" aria-controls="view-stats">日別集計</a>
        <a href="#custom" data-tab="custom" aria-controls="view-custom">カスタマイズ</a>
      </nav>
      <span class="muted" id="status">停止中</span>
    </header>

    <!-- ===== Timer ===== -->
    <section id="view-timer" data-view="timer" class="card">
      <div class="row" role="group" aria-label="基本設定">
        <label>カテゴリ：<select id="category" aria-label="カテゴリ"></select></label>
        <input id="newCat" placeholder="新しいカテゴリ名を追加" aria-label="新しいカテゴリ名">
        <button class="btn" id="addCat" title="カテゴリを追加" aria-label="カテゴリを追加">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        </button>
        <button class="btn danger" id="delCat" title="カテゴリを削除" aria-label="カテゴリを削除">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7v10m6-10v10M8 7l1-2h6l1 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <label>作業（分）：<input id="workMin" type="number" min="1" value="25"></label>
        <label>休憩（分）：<input id="breakMin" type="number" min="1" value="5"></label>
      </div>

      <div class="timer-wrap">
        <div class="timer-box">
          <div class="timer-bg" id="timerBg"></div>
          <div class="timer" id="display" aria-live="polite">25:00</div>
        </div>
        <div class="btn-row">
          <button class="btn primary icon-btn" id="startBtn" title="スタート" aria-label="スタート"><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M8 6l10 6-10 6V6z" fill="currentColor"/></svg></button>
          <button class="btn icon-btn" id="pauseBtn" title="一時停止" aria-label="一時停止" disabled><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M8 6h3v12H8zM13 6h3v12h-3z" fill="currentColor"/></svg></button>
          <button class="btn icon-btn" id="resumeBtn" title="再開" aria-label="再開" disabled><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M8 6l10 6-10 6V6z" fill="currentColor"/></svg></button>
          <button class="btn icon-btn danger" id="stopBtn" title="停止して記録" aria-label="停止して記録" disabled><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M7 7h10v10H7z" fill="currentColor"/></svg></button>
          <button class="btn icon-btn" id="skipBreak" title="休憩をスキップ" aria-label="休憩をスキップ" disabled><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M5 6l7 6-7 6V6zM13 6h2v12h-2z" fill="currentColor"/></svg></button>
        </div>
      </div>
      <p class="muted small-note" style="margin:6px 0 0">※「停止して記録」は作業時間のみを履歴に保存します（休憩は記録しません）。</p>
    </section>

    <!-- ===== Logs & Stats ===== -->
    <section class="grid grid-2" style="margin-top:12px">
      <div id="view-logs" data-view="logs" class="card" hidden>
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:8px">
            <button class="btn" id="exportBtn" title="CSVエクスポート" aria-label="CSVエクスポート">
              <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0l-3-3m3 3l3-3M5 18h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="btn danger" id="clearBtn" title="履歴を全消去" aria-label="履歴を全消去">
              <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7v10m6-10v10M8 7l1-2h6l1 2M6 7l1 12h10l1-12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
          <span class="muted" id="totals"></span>
        </div>
        <table id="logTable">
          <thead><tr><th>日時</th><th>カテゴリ</th><th class="right">作業時間</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="view-stats" data-view="stats" class="card" hidden>
        <div class="row" style="justify-content:space-between;align-items:center">
          <span class="muted">直近 <span id="rangeInfo">14</span> 日</span>
          <label>表示範囲：
            <select id="rangeSel"><option value="7">7</option><option value="14" selected>14</option><option value="30">30</option></select> 日
          </label>
        </div>
        <canvas id="dailyChart" height="220"></canvas>
      </div>
    </section>

    <!-- ===== Customize ===== -->
    <section id="view-custom" data-view="custom" class="card" hidden>
      <div class="row" style="align-items:flex-end">
        <label>フォント：
          <select id="fontSel"><option value="sans">Noto Sans JP</option><option value="serif">Noto Serif JP</option></select>
        </label>
      </div>

      <div class="row" style="gap:12px;margin-top:10px">
        <label>背景色：<input type="color" id="bgColor" value="#ffffff"></label>
        <label>テキスト色（UI全体）：<input type="color" id="uiColor" value="#111827"></label>
        <label>タイマー色：<input type="color" id="timerColor" value="#000000"></label>

        <span style="flex-basis:100%;height:0"></span>

        <label>カード背景色：<input type="color" id="cardColor" value="#ffffff"></label>
        <label style="display:inline-flex;align-items:center;gap:6px">
          <input type="checkbox" id="cardTrans" checked> 背景色にあわせて透過
        </label>

        <button class="btn" id="applyColors">適用</button>
        <button class="btn" id="clearColors">個別色をクリア</button>
      </div>

      <div class="row" style="margin-top:12px">
        <label>タイマー背景画像（30%透過）：<input id="bgFile" type="file" accept="image/*"></label>
        <button class="btn danger" id="clearBg">背景を削除</button>
        <label>休憩用背景画像（40%透過）：<input id="bgBreakFile" type="file" accept="image/*"></label>
        <button class="btn danger" id="clearBgBreak">休憩背景を削除</button>
        <span class="muted">※ 端末内に保存（localStorage）。</span>
      </div>

      <!-- プレビュー（作業／休憩） -->
      <div class="card" style="margin-top:12px">
        <strong>プレビュー</strong>
        <div class="timer-box" style="margin-top:10px">
          <div class="timer-bg" id="timerBgPreview" style="opacity:.7"></div>
          <div class="timer" style="margin:0;padding:8px 0">00:00</div>
        </div>
        <div class="timer-box" style="margin-top:10px">
          <div class="timer-bg" id="timerBgBreakPreview" style="opacity:.6"></div>
          <div class="timer" style="margin:0;padding:8px 0;opacity:.6">Break</div>
        </div>
      </div>
    </section>

    <!-- ===== Clock ===== -->
    <section id="view-clock" data-view="clock" class="card" hidden>
      <div class="timer-wrap">
        <div class="timer-box">
          <div class="timer-bg" id="clockBg" style="opacity:.7"></div>
          <div class="timer" id="clockDisplay" aria-live="polite">00:00:00</div>
        </div>
        <p class="muted" id="clockDate" style="text-align:center;margin-top:4px;"></p>
      </div>
    </section>
  </div>

  <!-- ★ モバイル：下部固定タブ（歯車アイコンに変更済） -->
  <nav class="bottom-tabs" aria-label="ボトムナビ">
    <button class="bt" data-tab="clock" aria-label="時計">
      <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.7"/><path d="M12 7v5l3 2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="sr-only">時計</span>
    </button>
    <button class="bt active" data-tab="timer" aria-label="タイマー">
      <svg viewBox="0 0 24 24" fill="none"><rect x="6" y="5" width="12" height="14" rx="6" stroke="currentColor" stroke-width="1.7"/><path d="M10 3h4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><circle cx="12" cy="12" r="1.2" fill="currentColor"/></svg>
      <span class="sr-only">タイマー</span>
    </button>
    <button class="bt" data-tab="logs" aria-label="履歴">
      <svg viewBox="0 0 24 24" fill="none"><path d="M8 7h11M8 12h11M8 17h11" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><circle cx="4.5" cy="7" r="1.2" fill="currentColor"/><circle cx="4.5" cy="12" r="1.2" fill="currentColor"/><circle cx="4.5" cy="17" r="1.2" fill="currentColor"/></svg>
      <span class="sr-only">履歴</span>
    </button>
    <button class="bt" data-tab="stats" aria-label="日別集計">
      <svg viewBox="0 0 24 24" fill="none"><rect x="5" y="12" width="3" height="7" rx="1" fill="currentColor"/><rect x="10.5" y="9" width="3" height="10" rx="1" fill="currentColor"/><rect x="16" y="6" width="3" height="13" rx="1" fill="currentColor"/></svg>
      <span class="sr-only">日別集計</span>
    </button>
    <button class="bt" data-tab="custom" aria-label="カスタマイズ">
      <!-- 歯車アイコン -->
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.7"/>
        <path d="M19.4 12c0-.3.02-.6.06-.9l1.66-1.28-1.2-2.08-2.02.5a7.3 7.3 0 0 0-1.56-.9l-.31-2.06h-2.4l-.31 2.06c-.55.2-1.08.49-1.56.9l-2.02-.5-1.2 2.08 1.66 1.28c-.04.3-.06.6-.06.9s.02.6.06.9L5.3 14.18l1.2 2.08 2.02-.5c.48.4 1.01.69 1.56.9l.31 2.06h2.4l.31-2.06c.55-.21 1.08-.5 1.56-.9l2.02.5 1.2-2.08-1.66-1.28c.04-.3.06-.6.06-.9Z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="sr-only">カスタマイズ</span>
    </button>
  </nav>

<script>
/* ===== Keys / helpers ===== */
const KEY='pomodoro.logs.v1', CATKEY='pomodoro.cats.v1';
const FONTKEY='pomodoro.font.v1';
const BGKEY='pomodoro.bg.v1';
const BGKEY_BREAK='pomodoro.bg.break.v1';
const BGOVR_KEY='pomodoro.override.bg.v1';
const UIOVR_KEY='pomodoro.override.ui.v1';
const FGOVR_KEY='pomodoro.override.fg.v1';
const CARDOVR_KEY='pomodoro.override.card.v1';
const CARDTRANS_KEY='pomodoro.override.cardtrans.v1';
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const pad=n=>String(n).padStart(2,'0');
function load(k){ try{ return JSON.parse(localStorage.getItem(k)) }catch{ return null } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]))}
const FONTS={sans:'"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif',serif:'"Noto Serif JP",serif'};
function hexToRgb(hex){ const m=(hex||'').trim().match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:null; }
function relLum({r,g,b}){ const f=v=>{v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4)}; return 0.2126*f(r)+0.7152*f(g)+0.0722*f(b); }

/* ===== Appearance ===== */
function applyAppearance(fontKey){
  const r=document.documentElement.style;
  r.setProperty('--font', FONTS.sans);
  r.setProperty('--font-timer', fontKey==='serif' ? FONTS.serif : FONTS.sans);

  const bg = load(BGOVR_KEY) || '#FFFFFF'; r.setProperty('--bg', bg);
  const ui = load(UIOVR_KEY) || ((hexToRgb(bg) && relLum(hexToRgb(bg))<0.5) ? '#FFFFFF' : '#111827');
  r.setProperty('--ui-fg', ui);
  r.setProperty('--muted', `color-mix(in oklab, ${ui} 70%, ${bg} 30%)`);

  const trans = load(CARDTRANS_KEY); const cardTransOn = (trans===null?true:!!trans); const cardOv = load(CARDOVR_KEY);
  r.setProperty('--card', cardTransOn ? 'rgba(255,255,255,.20)' : (cardOv || '#FFFFFF'));

  const basis = (!cardTransOn && cardOv) ? cardOv : bg;
  const dark = (hexToRgb(basis) && relLum(hexToRgb(basis))<0.5);
  if(dark){
    r.setProperty('--field-bg','#0f1e26'); r.setProperty('--field-fg','#ffffff');
    r.setProperty('--field-border','#355560'); r.setProperty('--field-focus','#68c6ff'); r.setProperty('--icons','#ffffff');
  }else{
    r.setProperty('--field-bg','#ffffff'); r.setProperty('--field-fg','#111827');
    r.setProperty('--field-border','#e5e7eb'); r.setProperty('--field-focus','#7dd3fc'); r.setProperty('--icons', ui);
  }

  const timerFg = load(FGOVR_KEY) || '#000000'; r.setProperty('--fg-timer', timerFg);
  const pv = document.querySelector('#timerBgPreview')?.nextElementSibling; if(pv) pv.style.color = timerFg;

  save(FONTKEY,fontKey);
}

/* ===== 背景画像（作業/休憩） ===== */
let workBgUrl=null, breakBgUrl=null;
function setWorkBg(dataUrl){
  workBgUrl = dataUrl || null;
  ['#timerBg','#timerBgPreview','#clockBg'].forEach(sel=>{
    const n=document.querySelector(sel); if(n) n.style.backgroundImage=workBgUrl?`url('${workBgUrl}')`:'none';
  });
}
function setBreakBg(dataUrl){
  breakBgUrl = dataUrl || null;
  const pv=document.querySelector('#timerBgBreakPreview');
  if(pv) pv.style.backgroundImage = breakBgUrl?`url('${breakBgUrl}')`:'none';
}
function applyModeBg(){
  const el=document.getElementById('timerBg');
  if(!el) return;
  if(mode==='break'){
    el.style.opacity = .6; /* 休憩＝40% */
    el.style.backgroundImage = breakBgUrl?`url('${breakBgUrl}')`:(workBgUrl?`url('${workBgUrl}')`:'none');
  }else{
    el.style.opacity = .7; /* 作業＝30% */
    el.style.backgroundImage = workBgUrl?`url('${workBgUrl}')`:'none';
  }
}

/* ===== State ===== */
let logs=load(KEY)||[];
let categories=load(CATKEY)||['学習','開発','家事','その他']; save(CATKEY,categories);

let mode='idle', startAt=0, elapsedWork=0, remain=0, ticker=null;

/* ===== Init ===== */
function renderCategoryOptions(selected){
  $('#category').innerHTML=categories.map(c=>`<option ${selected===c?'selected':''}>${escapeHtml(c)}</option>`).join('');
}
function initUI(){
  renderCategoryOptions();

  const f=load(FONTKEY)||'sans';
  $('#fontSel').value=f; applyAppearance(f);

  const savedWork=load(BGKEY); if(savedWork) setWorkBg(savedWork);
  const savedBreak=load(BGKEY_BREAK); if(savedBreak) setBreakBg(savedBreak);

  const bgOv=load(BGOVR_KEY), uiOv=load(UIOVR_KEY),
        timerOv=load(FGOVR_KEY), cardOv=load(CARDOVR_KEY), cardTr=load(C
