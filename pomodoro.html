<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼</title>
<meta name="description" content="ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆã€åœæ­¢ã§æ™‚é–“ã‚’è‡ªå‹•è¨˜éŒ²ã™ã‚‹ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ã€‚">
<style>
  :root{--bg:#0b0c10;--fg:#eef2f4;--muted:#9aa5ad;--card:#131720;--line:#232b36;--brand:#7dd3fc;--brand2:#a78bfa}
  @media (prefers-color-scheme: light){:root{--bg:#f6f8fb;--fg:#0b1020;--muted:#5a6473;--card:#fff;--line:#e6eaf1}}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;line-height:1.6}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:900px;margin:auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  h1{margin:.4rem 0 1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input,button{padding:.6rem .8rem;border:1px solid var(--line);border-radius:10px;background:transparent;color:inherit}
  button{cursor:pointer}
  .primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#081018;border:none;font-weight:700}
  .danger{border-color:#ff6b6b}
  .timer{font-weight:800; font-size:clamp(36px,8vw,72px); text-align:center; margin:10px 0}
  .pill{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;padding:.25rem .6rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:15px}
  th,td{border-bottom:1px solid var(--line);padding:.5rem .4rem;text-align:left}
  tfoot td{font-weight:700}
  .right{text-align:right}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <strong>ğŸ… ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</strong>
        <span class="pill" id="status">åœæ­¢ä¸­</span>
      </div>
      <a class="pill" href="./">â† ãƒˆãƒƒãƒ—ã¸</a>
    </header>

    <section class="card">
      <h1>ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</h1>
      <div class="row">
        <label>ã‚«ãƒ†ã‚´ãƒªï¼š
          <select id="category"></select>
        </label>
        <input id="newCat" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’è¿½åŠ " />
        <button id="addCat">è¿½åŠ </button>

        <label>ä½œæ¥­<span class="muted">ï¼ˆåˆ†ï¼‰</span>ï¼š
          <input id="workMin" type="number" min="1" value="25" style="width:80px">
        </label>
        <label>ä¼‘æ†©<span class="muted">ï¼ˆåˆ†ï¼‰</span>ï¼š
          <input id="breakMin" type="number" min="1" value="5" style="width:80px">
        </label>
      </div>

      <div class="timer" id="display">25:00</div>

      <div class="row">
        <button class="primary" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="pauseBtn" disabled>ä¸€æ™‚åœæ­¢</button>
        <button id="resumeBtn" disabled>å†é–‹</button>
        <button class="danger" id="stopBtn" disabled>åœæ­¢ã—ã¦è¨˜éŒ²</button>
        <button id="skipBreak" disabled>ä¼‘æ†©ã‚¹ã‚­ãƒƒãƒ—</button>
      </div>
      <p class="muted" style="margin:.6rem 0 0">â€»ã€Œåœæ­¢ã—ã¦è¨˜éŒ²ã€ã¯**ä½œæ¥­æ™‚é–“ã®ã¿**ã‚’å±¥æ­´ã¸ä¿å­˜ã—ã¾ã™ï¼ˆä¼‘æ†©ã¯è¨˜éŒ²ã—ã¾ã›ã‚“ï¼‰ã€‚</p>
    </section>

    <section class="card" style="margin-top:12px">
      <h2 style="margin:0 0 .6rem">å±¥æ­´</h2>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="exportBtn">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="clearBtn" class="danger">å±¥æ­´ã‚’å…¨æ¶ˆå»</button>
        </div>
        <span class="muted" id="totals"></span>
      </div>
      <table id="logTable">
        <thead><tr><th>æ—¥æ™‚</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th class="right">ä½œæ¥­æ™‚é–“</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

<script>
/* ====== çŠ¶æ…‹ã¨ä¿å­˜ ====== */
const KEY = 'pomodoro.logs.v1';
const CATKEY = 'pomodoro.cats.v1';
const $ = s => document.querySelector(s);
const pad = n => n.toString().padStart(2,'0');

let logs = load(KEY) || [];
let categories = load(CATKEY) || ['å­¦ç¿’','é–‹ç™º','å®¶äº‹','ãã®ä»–'];
save(CATKEY, categories);

function load(k){ try{ return JSON.parse(localStorage.getItem(k)) }catch{ return null } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

/* ====== ã‚¿ã‚¤ãƒãƒ¼ ====== */
let mode = 'idle';          // 'work' | 'break' | 'idle' | 'paused'
let startAt = 0;            // ä½œæ¥­é–‹å§‹ã®UNIX(ms)
let elapsedWork = 0;        // ä½œæ¥­çµŒémsï¼ˆãƒãƒ¼ã‚ºå¯¾å¿œï¼‰
let remain = 0;             // ä»Šã®ãƒ¢ãƒ¼ãƒ‰ã®æ®‹ã‚Šms
let ticker = null;

function initUI(){
  // ã‚«ãƒ†ã‚´ãƒªé¸æŠ
  const sel = $('#category'); sel.innerHTML = categories.map(c=>`<option>${escape(c)}</option>`).join('');
  // ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤åˆæœŸåŒ–
  const wm = +$('#workMin').value || 25;
  updateDisplay(wm*60*1000);
  updateStatus('åœæ­¢ä¸­');
  renderLogs();
}
function escape(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))}

function updateDisplay(ms){
  const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000);
  $('#display').textContent = `${pad(m)}:${pad(s)}`;
}
function updateStatus(text){ $('#status').textContent = text }

function startTimer(){
  if(mode!=='idle') return;
  const wm = (+$('#workMin').value||25)*60*1000;
  remain = wm;
  elapsedWork = 0;
  startAt = Date.now();
  mode = 'work';
  enableRunning(true);
  updateStatus('ä½œæ¥­ä¸­');
  tick();
}
function pauseTimer(){
  if(mode!=='work') return;
  mode = 'paused';
  elapsedWork += Date.now() - startAt;
  clearInterval(ticker); ticker=null;
  $('#pauseBtn').disabled = true;
  $('#resumeBtn').disabled = false;
  updateStatus('ä¸€æ™‚åœæ­¢');
}
function resumeTimer(){
  if(mode!=='paused') return;
  mode = 'work';
  startAt = Date.now();
  $('#pauseBtn').disabled = false;
  $('#resumeBtn').disabled = true;
  updateStatus('ä½œæ¥­ä¸­');
  tick();
}
function stopAndLog(){
  // ä½œæ¥­ä¸­ or ä¸€æ™‚åœæ­¢ä¸­ã®ã¿ã€ä½œæ¥­æ™‚é–“ã‚’ãƒ­ã‚°
  let workMs = elapsedWork;
  if(mode==='work'){ workMs += (Date.now() - startAt); }
  if(workMs < 1000){ // 1ç§’æœªæº€ã¯ç„¡è¦–
    resetAll(); return;
  }
  logs.unshift({
    at: Date.now(),
    category: $('#category').value,
    ms: workMs
  });
  save(KEY, logs);
  resetAll();
  renderLogs();
}

function toBreak(){
  const bm = (+$('#breakMin').value||5)*60*1000;
  remain = bm;
  startAt = Date.now();
  mode = 'break';
  updateStatus('ä¼‘æ†©ä¸­');
  $('#pauseBtn').disabled = true;
  $('#resumeBtn').disabled = true;
  $('#skipBreak').disabled = false;
  tick();
}

function resetAll(){
  clearInterval(ticker); ticker=null;
  mode='idle'; remain=0; elapsedWork=0;
  $('#pauseBtn').disabled = true;
  $('#resumeBtn').disabled = true;
  $('#stopBtn').disabled = true;
  $('#skipBreak').disabled = true;
  $('#startBtn').disabled = false;
  const wm = (+$('#workMin').value||25)*60*1000;
  updateDisplay(wm);
  updateStatus('åœæ­¢ä¸­');
}

function tick(){
  clearInterval(ticker);
  ticker = setInterval(()=>{
    const now = Date.now();
    const spent = now - startAt;
    const left = Math.max(0, remain - spent);
    updateDisplay(left);
    if(left<=0){
      clearInterval(ticker); ticker=null;
      if(mode==='work'){
        // ä½œæ¥­ãŒçµ‚ã‚ã£ãŸã‚‰ä¼‘æ†©ã¸ï¼ˆè¨˜éŒ²ã¯åœæ­¢ãƒœã‚¿ãƒ³ã§è¡Œã†æƒ³å®šï¼‰
        elapsedWork += remain; // remain=ä½œæ¥­äºˆå®šæ™‚é–“
        toBreak();
        beep();
      }else if(mode==='break'){
        resetAll();
        beep();
      }
    }
  }, 250);
}

function enableRunning(on){
  $('#startBtn').disabled = on;
  $('#pauseBtn').disabled = !on;
  $('#stopBtn').disabled = !on;
  $('#resumeBtn').disabled = true;
  $('#skipBreak').disabled = true;
}

/* ====== å±¥æ­´è¡¨ç¤ºãƒ»é›†è¨ˆ ====== */
function renderLogs(){
  const tb = $('#logTable tbody'); tb.innerHTML = '';
  let sumByCat = {};
  for(const x of logs){
    sumByCat[x.category] = (sumByCat[x.category]||0) + x.ms;
    const tr = document.createElement('tr');
    const d = new Date(x.at);
    tr.innerHTML = `
      <td>${d.toLocaleString()}</td>
      <td>${escape(x.category)}</td>
      <td class="right">${fmtMin(x.ms)}</td>`;
    tb.appendChild(tr);
  }
  // åˆè¨ˆè¡¨ç¤º
  const pairs = Object.entries(sumByCat).map(([k,v])=>`${k}:${fmtMin(v)}`).join(' ï¼ ');
  $('#totals').textContent = pairs? `ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆè¨ˆ â†’ ${pairs}` : 'ã¾ã è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“';
}
function fmtMin(ms){ const m=Math.round(ms/60000); return `${m}åˆ†` }

/* ====== éŸ³ï¼ˆç°¡æ˜“ãƒ“ãƒ¼ãƒ—ï¼‰ ====== */
function beep(){
  try{
    const a = new (window.AudioContext||window.webkitAudioContext)();
    const o = a.createOscillator(); const g = a.createGain();
    o.connect(g); g.connect(a.destination);
    o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.05, a.currentTime);
    o.start(); setTimeout(()=>{ o.stop(); a.close(); }, 250);
  }catch{}
}

/* ====== ã‚¤ãƒ™ãƒ³ãƒˆå‰²å½“ ====== */
$('#startBtn').onclick = startTimer;
$('#pauseBtn').onclick = pauseTimer;
$('#resumeBtn').onclick = resumeTimer;
$('#stopBtn').onclick = stopAndLog;
$('#skipBreak').onclick = ()=>{ if(mode==='break'){ resetAll(); } };

$('#addCat').onclick = ()=>{
  const v = $('#newCat').value.trim(); if(!v) return;
  if(!categories.includes(v)){ categories.push(v); save(CATKEY, categories); }
  $('#newCat').value='';
  initUI();
};

$('#exportBtn').onclick = ()=>{
  const header = 'datetime,category,minutes\n';
  const rows = logs.map(x=>{
    const d = new Date(x.at).toISOString();
    return `${d},${x.category.replaceAll(',',' ')},${Math.round(x.ms/60000)}`;
  }).join('\n');
  const blob = new Blob([header+rows], {type:'text/csv'});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'pomodoro_logs.csv'});
  a.click(); URL.revokeObjectURL(a.href);
};
$('#clearBtn').onclick = ()=>{
  if(confirm('å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ logs=[]; save(KEY, logs); renderLogs(); }
};

// å…¥åŠ›æ™‚é–“ãŒå¤‰ã‚ã£ãŸã‚‰è¡¨ç¤ºã‚‚æ›´æ–°
$('#workMin').oninput = ()=>{ if(mode==='idle'){ updateDisplay((+$('#workMin').value||25)*60*1000) } };

initUI();
</script>
</body>
</html>
/* ---- å°ã•ãªæ•´ãˆ ---- */
.wrap{max-width: 980px}
.card{border-radius: 14px}
.row button, .row input, .row select{height: 40px}
.timer{letter-spacing: .02em}
.muted{color: var(--muted)}
/* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯æ¨ªå¹…ã«ãƒ•ã‚£ãƒƒãƒˆ */
canvas{width:100%; height:auto; display:block}
