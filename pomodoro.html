<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ポモドーロタイマー</title>
<meta name="description" content="カテゴリを選んでスタート、停止で時間を自動記録するポモドーロ。日別集計グラフつき。">
<style>
  /* ===== Design tokens ===== */
  :root{
    --bg:#f7f8fb;         /* 背景（ライト） */
    --fg:#0b1020;         /* 文字（ライト） */
    --muted:#5a6473;      /* 補助文字 */
    --card:#ffffff;       /* カード背景 */
    --line:#e6eaf1;       /* 枠線 */
    --brand:#5cc9ee;      /* 主ボタン */
    --brand2:#9aa7ff;     /* アクセント/グラデ */
    --radius:12px;        /* 角丸 */
    --shadow:0 8px 18px rgba(20,30,60,.06); /* 薄めの影 */
    --wrap:1000px;
    --space:14px;
    --focus:#7aa2ff;
    --btnh:44px;
    --font: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b0c10; --fg:#eef2f4; --muted:#9aa5ad; --card:#131720; --line:#232b36;
      --shadow:0 10px 22px rgba(0,0,0,.18);
    }
  }

  /* ===== Base ===== */
  *{box-sizing:border-box}
  html{font-size:17px}
  body{margin:0; background:var(--bg); color:var(--fg); font-family:var(--font); line-height:1.7}
  a{color:inherit; text-decoration:none}
  .wrap{max-width:var(--wrap); margin:auto; padding:16px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .muted{color:var(--muted)}

  /* ===== App bar & Tabs ===== */
  .appbar{position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
    background: color-mix(in oklab, var(--bg) 82%, transparent);
    border:1px solid var(--line); border-radius:calc(var(--radius) + 4px);
    display:flex; justify-content:space-between; align-items:center; padding:10px 12px; margin-bottom:12px;
  }
  .tabs a{display:inline-flex; align-items:center; gap:6px; padding:.45rem .7rem; border-radius:10px; border:1px solid transparent}
  .tabs a.active{border-color:var(--line); background:linear-gradient(180deg, rgba(255,255,255,.05), transparent)}
  .logo{font-weight:800; letter-spacing:.02em}

  /* ===== Controls ===== */
  select,input,button{height:var(--btnh); padding:.6rem .8rem; border:1px solid var(--line); border-radius:10px; background:transparent; color:inherit}
  input[type="number"]{width:88px}
  button{cursor:pointer}
  .btn{display:inline-flex; align-items:center; gap:8px}
  .primary{background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#081018; border:none; font-weight:700}
  .danger{border-color:#ff6b6b}
  .timer{font-weight:800; font-size:clamp(38px,8vw,78px); text-align:center; letter-spacing:.02em; margin:12px 0}

  /* ===== Grid ===== */
  .grid{display:grid; gap:var(--space)}
  @media (min-width:600px){
    .grid-2{grid-template-columns:1.2fr 1fr}
  }

  /* ===== Table ===== */
  table{width:100%; border-collapse:collapse; margin-top:10px; font-size:15px}
  th,td{border-bottom:1px solid var(--line); padding:.55rem .4rem; text-align:left}
  .right{text-align:right}

  /* ===== Canvas ===== */
  canvas{width:100%; height:auto; display:block}

  /* ===== Accessibility ===== */
  :focus-visible{outline:2px solid var(--focus); outline-offset:2px}
  @media (prefers-reduced-motion: reduce){
    .tabs a, .btn{transition:none}
  }

  /* ===== Icon ===== */
  .icon{width:18px; height:18px; display:inline-block}
</style>
</head>
<body>
  <div class="wrap">
    <!-- App bar with tabs -->
    <header class="appbar">
      <strong class="logo">Pomodoro</strong>
      <nav class="tabs" aria-label="主要タブ">
        <a href="#top" class="active" data-tab>タイマー</a>
        <a href="#logs" data-tab>履歴</a>
        <a href="#stats" data-tab>日別集計</a>
      </nav>
      <span class="muted" id="status">停止中</span>
    </header>

    <!-- 操作 -->
    <section id="top" class="card">
      <h1 style="margin:.2rem 0 1rem">カテゴリを選んでスタート</h1>
      <div class="row" role="group" aria-label="基本設定">
        <label>カテゴリ：
          <select id="category" aria-label="カテゴリ"></select>
        </label>
        <input id="newCat" placeholder="新しいカテゴリ名を追加" aria-label="新しいカテゴリ名">
        <button class="btn" id="addCat" aria-label="カテゴリを追加">
          <!-- plus icon -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>追加
        </button>

        <label>作業（分）：
          <input id="workMin" type="number" min="1" value="25" aria-label="作業分数">
        </label>
        <label>休憩（分）：
          <input id="breakMin" type="number" min="1" value="5" aria-label="休憩分数">
        </label>
      </div>

      <div class="timer" id="display" aria-live="polite">25:00</div>

      <div class="row" role="group" aria-label="操作ボタン">
        <button class="btn primary" id="startBtn" aria-label="スタート">
          <!-- play icon -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M8 6l10 6-10 6V6z" fill="currentColor"/>
          </svg>スタート
        </button>
        <button class="btn" id="pauseBtn" disabled aria-label="一時停止">
          <!-- pause icon -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M8 6h3v12H8zM13 6h3v12h-3z" fill="currentColor"/>
          </svg>一時停止
        </button>
        <button class="btn" id="resumeBtn" disabled aria-label="再開">
          <!-- resume (play) -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M8 6l10 6-10 6V6z" fill="currentColor"/>
          </svg>再開
        </button>
        <button class="btn danger" id="stopBtn" disabled aria-label="停止して記録">
          <!-- stop icon -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 7h10v10H7z" fill="currentColor"/>
          </svg>停止して記録
        </button>
        <button class="btn" id="skipBreak" disabled aria-label="休憩をスキップ">
          <!-- skip icon -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 6l7 6-7 6V6zM13 6h2v12h-2z" fill="currentColor"/>
          </svg>休憩スキップ
        </button>
      </div>
      <p class="muted" style="margin:.6rem 0 0">※「停止して記録」は<strong>作業時間のみ</strong>を履歴へ保存します（休憩は記録しません）。</p>
    </section>

    <!-- 2カラム：履歴 / グラフ -->
    <section class="grid grid-2" style="margin-top:12px">
      <!-- 履歴 -->
      <div id="logs" class="card">
        <h2 style="margin:0 0 .6rem">履歴</h2>
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:8px">
            <button class="btn" id="exportBtn" aria-label="CSVエクスポート">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 3v12m0 0l-3-3m3 3l3-3M5 18h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>CSVエクスポート
            </button>
            <button class="btn danger" id="clearBtn" aria-label="履歴を全消去">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 7h12M9 7v10m6-10v10M8 7l1-2h6l1 2M6 7l1 12h10l1-12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>履歴を全消去
            </button>
          </div>
          <span class="muted" id="totals"></span>
        </div>
        <table id="logTable" aria-label="作業履歴">
          <thead><tr><th>日時</th><th>カテゴリ</th><th class="right">作業時間</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 日別集計グラフ -->
      <div id="stats" class="card">
        <h2 style="margin:0 0 .6rem">日別集計</h2>
        <div class="row" style="justify-content:space-between;align-items:center">
          <span class="muted">直近 <span id="rangeInfo">14</span> 日</span>
          <label>表示範囲：
            <select id="rangeSel" aria-label="表示範囲（日数）">
              <option value="7">7</option>
              <option value="14" selected>14</option>
              <option value="30">30</option>
            </select> 日
          </label>
        </div>
        <canvas id="dailyChart" height="220" aria-label="日別合計（分）の棒グラフ"></canvas>
      </div>
    </section>
  </div>

<script>
/* ========= 基本ユーティリティ ========= */
const KEY='pomodoro.logs.v1', CATKEY='pomodoro.cats.v1';
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const pad=n=>String(n).padStart(2,'0');
function load(k){ try{ return JSON.parse(localStorage.getItem(k)) }catch{ return null } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))}

/* ========= 状態 ========= */
let logs = load(KEY) || [];
let categories = load(CATKEY) || ['学習','開発','家事','その他']; save(CATKEY, categories);

let mode='idle';        // 'work' | 'break' | 'paused' | 'idle'
let startAt=0;          // 現モード開始時刻
let elapsedWork=0;      // 作業の実経過（ポーズ対応）
let remain=0;           // 現モードの残りms
let ticker=null;

/* ========= 初期化 ========= */
function initUI(){
  const sel = $('#category'); sel.innerHTML = categories.map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  const wm = (+$('#workMin').value||25)*60*1000; updateDisplay(wm); updateStatus('停止中');
  renderLogs(); drawDailyChart();
  // タブのactive
  updateTabs();
}
function updateTabs(){
  const hash = location.hash || '#top';
  $$('.tabs a').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===hash));
}
window.addEventListener('hashchange', updateTabs);

function updateDisplay(ms){ const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000); $('#display').textContent=`${pad(m)}:${pad(s)}` }
function updateStatus(t){ $('#status').textContent=t }

/* ========= タイマー制御 ========= */
function enableRunning(on){
  $('#startBtn').disabled=on; $('#pauseBtn').disabled=!on; $('#stopBtn').disabled=!on;
  $('#resumeBtn').disabled=true; $('#skipBreak').disabled=true;
}
function startTimer(){
  if(mode!=='idle') return;
  const wm=(+$('#workMin').value||25)*60*1000;
  remain=wm; elapsedWork=0; startAt=Date.now(); mode='work';
  enableRunning(true); updateStatus('作業中'); tick();
}
function pauseTimer(){ if(mode!=='work')return; mode='paused'; elapsedWork+=Date.now()-startAt; clearInterval(ticker); $('#pauseBtn').disabled=true; $('#resumeBtn').disabled=false; updateStatus('一時停止'); }
function resumeTimer(){ if(mode!=='paused')return; mode='work'; startAt=Date.now(); $('#pauseBtn').disabled=false; $('#resumeBtn').disabled=true; updateStatus('作業中'); tick(); }
function stopAndLog(){
  let workMs=elapsedWork; if(mode==='work') workMs+=Date.now()-startAt;
  if(workMs>=1000){ logs.unshift({at:Date.now(), category:$('#category').value, ms:workMs}); save(KEY,logs); }
  resetAll(); renderLogs(); drawDailyChart();
}
function t
